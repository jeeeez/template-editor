{"version":3,"sources":["C:/Users/JF/Desktop/template-editor/packages/editor/src/mode.ts","C:/Users/JF/Desktop/template-editor/packages/editor/src/createSpanReplacementNode.ts","C:/Users/JF/Desktop/template-editor/packages/editor/src/index.ts","C:/Users/JF/Desktop/template-editor/packages/react-template-editor/src/index.tsx","C:/Users/JF/Desktop/template-editor/packages/react-template-editor/docz/demos/usage1/index.tsx","C:/Users/JF/Desktop/template-editor/packages/react-template-editor/docz/demos/usage1/index.mdx"],"names":["counter","createSpanReplacementNode","innerHTML","className","$span","document","createElement","split","forEach","subClassName","classList","add","container","options","config","name","mode","placeholders","Date","now","defineMode","tokenBase","stream","state","line","lineOracle","placeholder","match","matchRegexp","consumeRegexp","matched","matchedValue","type","next","startState","tokenize","context","token","eatSpace","undefined","lineWrapping","this","instance","scrollbarStyle","readOnly","disabled","value","initialValue","replaceVariables","listenContentChange","on","createReplacementNode","getDoc","getAllMarks","mark","clear","getTokens","startPos","ch","start","endPos","end","replacedWith","string","hasOwnProperty","text","markText","tokens","eachLine","getLineTokens","lineNo","push","getValue","setValue","input","onChange","change","ReactTemplateEditor","props","ref","editorRef","editor","setEditorInstance","current","forceUpdateEditor","setTimeout","rest","DefaultPlaceholders","ReactTemplateEditorWrapper","editorRefObj","layoutProps","MDXLayout","MDXContent","components","mdxType","__position","__code","__scope","Playground","__codesandbox","isMDXComponent"],"mappings":"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","file":"static/js/docz-demos-usage1-index.55085db2.js","sourcesContent":["import CodeMirror from 'codemirror';\nimport { IPlaceholder } from './index.d';\n\n\ninterface IModeConfig {\n  placeholders: IPlaceholder[];\n}\n\nlet counter = 0;\n\nexport function defineMode(config: IModeConfig) {\n  const name = `Template-Editor-${++counter}-${Date.now()}`;\n\n  CodeMirror.defineMode(name, () => {\n\n    function tokenBase(stream: CodeMirror.StringStream, state: any) {\n      state.line = (stream as any).lineOracle.line;\n      for (const placeholder of config.placeholders) {\n        if (stream.match(placeholder.matchRegexp, false)) {\n\n          const consumeRegexp = placeholder.consumeRegexp || placeholder.matchRegexp;\n          const matched = stream.match(consumeRegexp);\n          state.placeholder = placeholder;\n          state.matchedValue = matched[1];\n          return placeholder.type;\n        }\n      }\n\n      stream.next();\n\n      return null;\n    }\n\n    return {\n      startState() {\n        return { tokenize: tokenBase, context: null };\n      },\n\n      token(stream, state: any) {\n        if (state.tokenize === tokenBase && stream.eatSpace()) {\n          state.placeholder = undefined;\n          state.matchedValue = undefined;\n          return null;\n        }\n\n        const style = state.tokenize(stream, state);\n\n        return style;\n      }\n    };\n  });\n  return name;\n}\n","\n/**\n * Create `span` for Placehoder display\n * @param innerHTML string\n * @param className string\n */\nexport function createSpanReplacementNode(innerHTML: string, className: string) {\n  const $span = document.createElement('span');\n  $span.innerHTML = innerHTML;\n  if (className) {\n    className.split(' ').forEach(subClassName => {\n      if (subClassName) {\n        $span.classList.add(subClassName);\n      }\n    });\n  }\n  return $span;\n}\n","import CodeMirror from 'codemirror';\nimport 'codemirror/lib/codemirror.css';\nrequire('codemirror/addon/scroll/simplescrollbars');\nimport 'codemirror/addon/scroll/simplescrollbars.css';\nimport { defineMode } from './mode';\nimport { IEditorOptions } from './index.d';\nimport { createSpanReplacementNode } from './createSpanReplacementNode';\nexport { createSpanReplacementNode } from './createSpanReplacementNode';\n\n\n\nexport class TemplateEditor {\n\n  public instance!: CodeMirror.Editor;\n\n  constructor(container: HTMLElement, private options: IEditorOptions) {\n\n    const mode = defineMode({\n      placeholders: options.placeholders\n    });\n\n    const lineWrapping = 'lineWrapping' in options ? !!options.lineWrapping : true;\n\n    this.instance = CodeMirror(container, {\n      mode,\n      lineWrapping,\n      scrollbarStyle: 'simple',\n      readOnly: options.disabled,\n      value: options.initialValue || '',\n      placeholder: options.placeholder\n    });\n\n\n    this.replaceVariables();\n    this.listenContentChange();\n  }\n\n  private listenContentChange() {\n    // if (!this.options.controlled) {\n    //   this.instance.on('beforeChange', (_R, change) => {\n    //     console.log(change,_R);\n    //     change.cancel();\n    //   });\n    // }\n\n    this.instance.on('change', () => {\n      this.replaceVariables();\n    });\n  }\n\n  private replaceVariables() {\n    const { createReplacementNode } = this.options;\n\n    const document = this.instance.getDoc();\n    document.getAllMarks().forEach(mark => {\n      mark.clear();\n    });\n\n    this.getTokens().forEach(token => {\n      if (token && token.type && token.state && token.state.placeholder) {\n\n        const line = token.state.line;\n        const startPos = { line, ch: token.start };\n        const endPos = { line, ch: token.end };\n\n        const placeholder = token.state.placeholder;\n        const matchedValue = token.state.matchedValue;\n\n        const replacedWith = createReplacementNode ?\n          createReplacementNode(placeholder, matchedValue, token.string) :\n          (() => {\n            const text = placeholder && placeholder.hasOwnProperty('text') ?\n              (typeof placeholder.text === 'string' ? placeholder.text : placeholder.text(matchedValue)) : matchedValue;\n            const className = placeholder && placeholder.hasOwnProperty('className') ? placeholder.className : 'cm-variable';\n            return createSpanReplacementNode(text, className);\n          })();\n\n        document.markText(startPos, endPos, {\n          replacedWith\n        });\n      }\n    });\n  }\n\n  public getTokens() {\n    const tokens: CodeMirror.Token[] = [];\n    const document = this.instance.getDoc();\n    document.eachLine(line => {\n      const lineTokens = this.instance.getLineTokens((line as any).lineNo());\n      lineTokens.forEach(token => tokens.push(token));\n    });\n    return tokens;\n  }\n\n  public getValue() {\n    return this.instance.getDoc().getValue();\n  }\n\n  public setValue(input: string) {\n    this.instance.getDoc().setValue(input);\n  }\n\n  public onChange(change: (input: string) => any) {\n    this.instance.on('change', () => {\n      change(this.getValue());\n    });\n  }\n\n  // public insert(input: string) {\n  //   const document = this.instance.getDoc();\n  //   const cursor = document.getCursor();\n  //   document.replaceRange(input, cursor, cursor);\n  // }\n}\n","import * as React from 'react';\nimport { TemplateEditor } from '@template-editor/native';\nimport { IProps, IImperativeHandles } from './index.d';\n\n\nconst Editor: React.RefForwardingComponent<IImperativeHandles, IProps> = (props, ref) => {\n  const {\n    value = '',\n    disabled,\n    placeholder,\n    placeholders,\n    createReplacementNode,\n    onChange,\n    ...rest } = props;\n  const editorRef = React.useRef<HTMLDivElement>(null);\n  const [editor, setEditorInstance] = React.useState<TemplateEditor>();\n\n  // componentDidMount\n  React.useEffect(() => {\n    setEditorInstance(new TemplateEditor(editorRef.current!, {\n      initialValue: value,\n      placeholders,\n      createReplacementNode\n    }));\n  }, []);\n\n  // add onchange listener\n  React.useEffect(() => {\n    if (onChange) {\n      editor!.onChange((input) => {\n        const tokens = editor!.getTokens();\n        onChange(input, tokens);\n      });\n    }\n  }, []);\n\n  // when value changed\n  React.useEffect(() => {\n    editor && editor.setValue(props.value);\n  }, [props.value]);\n\n\n  // when other props changed, Codemirror need to re-parse\n  React.useImperativeHandle(ref, () => ({\n    forceUpdateEditor: () => {\n      editor!.setValue(props.value + ' ');\n      setTimeout(() => {\n        editor!.setValue(props.value);\n      }, 0);\n    }\n  }));\n\n  return (\n    <div ref={editorRef} {...rest}></div>\n  );\n};\n\nexport const ReactTemplateEditor = React.forwardRef(Editor);\n","import * as React from 'react';\nimport { ReactTemplateEditor } from '@template-editor/react';\nimport { IImperativeHandles } from '@template-editor/react/index.d';\n\n\nconst DefaultPlaceholders = [{\n  type: 'variable',\n  matchRegexp: /^\\{\\{(123)\\}\\}/,\n  className: 'cm-keyword',\n  text: 'nickname'\n}];\n\n\nexport function ReactTemplateEditorWrapper() {\n  const editorRefObj = React.useRef<IImperativeHandles>(null);\n  const [value] = React.useState('{{123}} {{124}}');\n  const [placeholders] = React.useState(DefaultPlaceholders);\n\n  React.useEffect(() => {\n    setTimeout(() => {\n      DefaultPlaceholders.push({\n        type: 'variable',\n        matchRegexp: /^\\{\\{(124)\\}\\}/,\n        className: 'cm-keyword',\n        text: 'age'\n      });\n      // console.log(editorRefObj.current);\n\n      editorRefObj.current!.forceUpdateEditor();\n    }, 2000);\n  }, []);\n\n\n  return (\n    <ReactTemplateEditor\n      ref={editorRefObj}\n      value={value}\n      placeholders={placeholders}\n      className='editor-instance'\n    />);\n}\n\n","/* @jsx mdx */\n  import React from 'react'\n  import { mdx } from '@mdx-js/react'\n  /* @jsx mdx */\nimport { Playground } from 'docz';\nimport { ReactTemplateEditorWrapper } from './index.tsx';\n\nconst makeShortcode = name => function MDXDefaultShortcode(props) {\n  console.warn(\"Component \" + name + \" was not imported, exported, or provided by MDXProvider as global scope\")\n  return <div {...props}/>\n};\n\nconst layoutProps = {\n  \n};\nconst MDXLayout = \"wrapper\"\nexport default function MDXContent({\n  components,\n  ...props\n}) {\n  return <MDXLayout {...layoutProps} {...props} components={components} mdxType=\"MDXLayout\">\n    <h1 {...{\n      \"id\": \"usage\"\n    }}>{`Usage`}</h1>\n\n    <Playground __position={0} __code={'<ReactTemplateEditorWrapper />'} __scope={{\n      props: this ? this.props : props,\n      Playground,\n      ReactTemplateEditorWrapper\n    }} __codesandbox={`undefined`} mdxType=\"Playground\">\n  <ReactTemplateEditorWrapper mdxType=\"ReactTemplateEditorWrapper\" />\n    </Playground>\n    </MDXLayout>;\n}\n\n;\nMDXContent.isMDXComponent = true;\n  "],"sourceRoot":""}